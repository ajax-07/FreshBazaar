name: FreshBazaar CI/CD Pipeline

on:
  push:
    branches: [ master]
    # paths-ignore:
    #   - 'docs/**'
    #   - '**.md'

# Permissions required for some actions (like test reporting)
permissions:
  checks: write
  contents: read

env:
  JAVA_VERSION: '21'
  NODE_VERSION: '18'
  REGISTRY: docker.io
  IMAGE_PREFIX: freshbazaar

jobs:
  # ------------------------------------------------------------------
  # JOB 1: BACKEND (Java/Spring Boot)
  # Handles Build, Unit Tests, and SonarQube Analysis
  # ------------------------------------------------------------------
  backend-ci:
    name: Backend Build & Quality
    runs-on: ubuntu-latest
    
    # Only run if backend files changed
    defaults:
      run:
        working-directory: ./services

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Important for SonarQube to detect new code

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        # uses: actions/setup-java@v4
        # with:
        #   java-version: ${{ env.JAVA_VERSION }}
        #   distribution: 'temurin'
        #   cache: 'gradle'
        run: echo "mocked setup-java for Java ${{ env.JAVA_VERSION }}"

      - name: Grant execute permission for gradlew
        # run: chmod +x gradlew
        run: echo "mocked chmod +x gradlew"

      # 1. Build and Run Unit Tests
      # If you have multiple modules (services), this runs tests for ALL of them.
      - name: Build & Test
        # run: ./gradlew build --no-daemon
        run: echo "mocked ./gradlew build --no-daemon"

      # 2. SonarQube / SonarCloud Scan
      # This runs ONLY if you have added the SONAR_TOKEN to GitHub Secrets.
      # If not, it skips nicely so your pipeline doesn't break while learning.
      - name: Sonar Scan
        uses: SonarSource/sonarcloud-github-action@v2
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.organization=ajax-07
            -Dsonar.projectKey=ajax-07_FreshBazaar
            -Dsonar.sources=.
            -Dsonar.exclusions=**/docs/**
      


      # # 3. Publish Test Results (Optional but good for reports)
      # - name: Publish Test Report
      #   uses: mikepenz/action-junit-report@v3
      #   if: success() || failure() # Run even if tests fail
      #   with:
      #     report_paths: '**/build/test-results/test/TEST-*.xml'

  # ------------------------------------------------------------------
  # JOB 2: FRONTEND (React/Vite)
  # Handles Linting, Building, and Testing
  # ------------------------------------------------------------------
  frontend-ci:
    name: Frontend Build & Test
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: ./apps/web-app

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Node.js ${{ env.NODE_VERSION }}
        # uses: actions/setup-node@v4
        # with:
        #   node-version: ${{ env.NODE_VERSION }}
        #   cache: 'npm'
          # cache-dependency-path: apps/package-lock.json
        run: echo "mocked setup-node for Node.js ${{ env.NODE_VERSION }}"

      - name: Install Dependencies
        # run: npm ci
        run: echo "mocked npm ci"

      - name: Lint Code
        # run: npm run lint
        run: echo "mocked npm run lint"
        continue-on-error: true # Don't break build on lint errors for now

      - name: Build Project
        # run: npm run build
        run: echo "mocked npm run build"

      # Only runs if you have test scripts defined in package.json
      - name: Run Unit Tests
        # run: npm test -- --passWithNoTests
        run: echo "mocked npm test -- --passWithNoTests"

  # ------------------------------------------------------------------
  # JOB 3: MOCK DEPLOY
  # Simulates deployment to "DockerHub" only if build/tests pass
  # ------------------------------------------------------------------
  mock-deploy:
    name: Deploy to DockerHub
    runs-on: ubuntu-latest
    needs: [backend-ci, frontend-ci] # Waits for previous jobs to finish
    if: github.ref == 'refs/heads/master'  # Only deploy from 'dev' branch
    
    steps:
      - name: Docker Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}

      - name: Build Docker Images and Push
        run: |
          docker build \
            -f infra/docker/Dockerfile.mock \
            -t ${{ secrets.DOCKER_USERNAME }}/freshbazaar-mock:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/freshbazaar-mock:latest
          
      - name: Start FreshBazaar Infrastructure
        working-directory: infra/docker
        run: |
            docker compose up -d
            docker ps